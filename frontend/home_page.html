<html>
  <head>
    <title>INST 377 Final Project</title>
    <link rel="stylesheet" href="style.css" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  </head>
  <body style="background-color: rgb(157, 188, 226)">
    <header>
      <h1>Lyrics Translator</h1>
      <!--Navigation Section-->
      <nav id="nav_bar">
        <ul>
          <li><a href="home_page.html">Home</a></li>
          <li><a href="full_lyrics.html">Full Lyrics</a></li>
          <li><a href="about_page.html">About</a></li>
        </ul>
      </nav>
    </header>
    <!--Line Separator-->
    <hr />
    <br />
    <!--Song Details Section-->
    <h2>Song Details</h2>
    <form id="songForm">
      <input type="text" id="song_title" placeholder="Song Title" required />
      <br />
      <input type="text" id="artist" placeholder="Artist" required />
      <br />
      <select id="original_language" name="original_language" required>
        <option value="" disabled selected>Original Language</option>
      </select>
      <select id="target_language" name="target_language" required>
        <option value="" disabled selected>Target Language</option>
      </select>
      <br />
      <div class="buttons">
        <button id="translateButton" type="submit">Translate</button>
        <button id="restartButton" type="submit">Restart</button>
      </div>
    </form>
    <!--Lyrics Preview Section-->
    <br />
    <div class="lyricsPreview">
      <h2>Preview</h2>
      <div class="lyric_boxes">
        <div class="original_lyrics">
          <h4>Original</h4>
          <p></p>
        </div>
        <div class="translated_lyrics">
          <h4>Translated</h4>
          <p></p>
        </div>
      </div>
    </div>
    <!--Full Lyrics Button-->
    <button id="fullLyricsButton" type="submit">View Full Lyrics</button>
  </body>
  <!--Javascript Section-->
  <script>
    // variables
    const original_language = document.getElementById("original_language");
    const target_language = document.getElementById("target_language");
    const originalBox = document.querySelector(".original_lyrics p");
    const translatedBox = document.querySelector(".translated_lyrics p");

    // hardcoded languages for target and original dropdown menus
    const sourceLangDeepL = [
      { code: "AR", name: "Arabic" },
      { code: "BG", name: "Bulgarian" },
      { code: "CS", name: "Czech" },
      { code: "DA", name: "Danish" },
      { code: "DE", name: "German" },
      { code: "EL", name: "Greek" },
      { code: "EN", name: "English" },
      { code: "ES", name: "Spanish" },
      { code: "ET", name: "Estonian" },
      { code: "FI", name: "Finnish" },
      { code: "FR", name: "French" },
      { code: "HE", name: "Hebrew" },
      { code: "HU", name: "Hungarian" },
      { code: "ID", name: "Indonesian" },
      { code: "IT", name: "Italian" },
      { code: "JA", name: "Japanese" },
      { code: "KO", name: "Korean" },
      { code: "LT", name: "Lithuanian" },
      { code: "LV", name: "Latvian" },
      { code: "NB", name: "Norwegian Bokmål" },
      { code: "NL", name: "Dutch" },
      { code: "PL", name: "Polish" },
      { code: "PT", name: "Portuguese" },
      { code: "RO", name: "Romanian" },
      { code: "RU", name: "Russian" },
      { code: "SK", name: "Slovak" },
      { code: "SL", name: "Slovenian" },
      { code: "SV", name: "Swedish" },
      { code: "TH", name: "Thai" },
      { code: "TR", name: "Turkish" },
      { code: "UK", name: "Ukrainian" },
      { code: "VI", name: "Vietnamese" },
      { code: "ZH", name: "Chinese" },
    ];

    const targetLangDeepL = [
      { code: "AR", name: "Arabic" },
      { code: "BG", name: "Bulgarian" },
      { code: "CS", name: "Czech" },
      { code: "DA", name: "Danish" },
      { code: "DE", name: "German" },
      { code: "EL", name: "Greek" },
      { code: "EN", name: "English" },
      { code: "EN-GB", name: "English (British)" },
      { code: "EN-US", name: "English (American)" },
      { code: "ES", name: "Spanish" },
      { code: "ES-419", name: "Spanish (Latin American)" },
      { code: "ET", name: "Estonian" },
      { code: "FI", name: "Finnish" },
      { code: "FR", name: "French" },
      { code: "HE", name: "Hebrew" },
      { code: "HU", name: "Hungarian" },
      { code: "ID", name: "Indonesian" },
      { code: "IT", name: "Italian" },
      { code: "JA", name: "Japanese" },
      { code: "KO", name: "Korean" },
      { code: "LT", name: "Lithuanian" },
      { code: "LV", name: "Latvian" },
      { code: "NB", name: "Norwegian Bokmål" },
      { code: "NL", name: "Dutch" },
      { code: "PL", name: "Polish" },
      { code: "PT", name: "Portuguese" },
      { code: "PT-BR", name: "Portuguese (Brazilian)" },
      { code: "PT-PT", name: "Portuguese (all variants except Brazilian)" },
      { code: "RO", name: "Romanian" },
      { code: "RU", name: "Russian" },
      { code: "SK", name: "Slovak" },
      { code: "SL", name: "Slovenian" },
      { code: "SV", name: "Swedish" },
      { code: "TH", name: "Thai" },
      { code: "TR", name: "Turkish" },
      { code: "UK", name: "Ukrainian" },
      { code: "VI", name: "Vietnamese" },
      { code: "ZH", name: "Chinese" },
      { code: "ZH-HANS", name: "Chinese (simplified)" },
      { code: "ZH-HANT", name: "Chinese (traditional)" },
    ];

    // adding the languages to the original_language and target_language dropdown menus
    function populateDropdowns() {
      sourceLangDeepL.forEach((lang) => {
        const option = document.createElement("option");
        option.value = lang.code;
        option.textContent = lang.name;
        original_language.appendChild(option);
      });

      targetLangDeepL.forEach((lang) => {
        const option = document.createElement("option");
        option.value = lang.code;
        option.textContent = lang.name;
        target_language.appendChild(option);
      });
    }
    populateDropdowns();

    // CREATE SUPABASE
    const supabaseClient = window.supabase.createClient(
      "https://odwiadxcegkrwcxelimv.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9kd2lhZHhjZWdrcndjeGVsaW12Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYwMjEyODMsImV4cCI6MjA4MTU5NzI4M30.RWc7FOjKHiyTQL_pkVu3UBJ8gUJvcoA2a7vgdMe4QVw"
    );

    console.log("Supabase client:", supabaseClient); // works

    // USER: clicks Translate button
    async function saveTranslation(
      id,
      title,
      artist,
      originalLang,
      targetLang,
      originalLyrics,
      translatedLyrics
    ) {
      // check if this translation already exists
      const { data: existing, error: selectError } = await supabaseClient
        .from("lyrics_data")
        .select("*")
        .eq("title", title)
        .eq("artist", artist)
        .eq("original_lang", originalLang)
        .eq("target_lang", targetLang)
        .limit(1);

      if (selectError) {
        console.error("Supabase select error:", selectError);
        return null;
      }

      if (existing && existing.length > 0) {
        console.log("Translation found:", existing[0]);
        return existing[0]; // return the translation
      }

      // if not found, insert it
      const { data, error: insertError } = await supabaseClient
        .from("lyrics_data")
        .insert([
          {
            id,
            title,
            artist,
            original_lang: originalLang,
            target_lang: targetLang,
            original_lyrics: originalLyrics,
            translated_lyrics: translatedLyrics,
          },
        ])
        .select();

      if (insertError) {
        console.error("Supabase insert error:", insertError);
        return null;
      }

      console.log("Translation saved:", data[0]);
      return data[0];
    }

    // COLLECT all the details
    document
      .getElementById("songForm")
      .addEventListener("submit", async (details) => {
        details.preventDefault(); // stop page from refreshing

        const title = document.getElementById("song_title").value;
        const artist = document.getElementById("artist").value;
        const originalLang = document.getElementById("original_language").value;
        const targetLang = document.getElementById("target_language").value;

        console.log({ title, artist, originalLang, targetLang });

        // Checking to see if all is working
        const id = Date.now();
        const originalLyrics = "temporary";
        const translatedLyrics = "temporary";

        // Check or save translation
        const translation = await saveTranslation(
          id,
          title,
          artist,
          originalLang,
          targetLang,
          originalLyrics,
          translatedLyrics
        );

        // Update page preview
        if (translation) {
          originalBox.textContent = translation.original_lyrics;
          translatedBox.textContent = translation.translated_lyrics;
        }
      });
  </script>
</html>
