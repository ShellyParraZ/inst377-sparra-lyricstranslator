{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 18, "column": 0}, "map": {"version":3,"sources":["file:///Users/shellyp/Documents/GitHub/inst377-sparra-lyricstranslator/pages/api/index.js"],"sourcesContent":["import { createClient } from \"@supabase/supabase-js\";\n\n// Initialize Supabase using environment variables\nconst supabase = createClient(\n  process.env.SUPABASE_URL,\n  process.env.SUPABASE_KEY\n);\n\n// DeepL API key\nconst DEEPL_API_KEY = process.env.DEEPL_API_KEY;\n\nexport default async function handler(req, res) {\n  console.log({\n    SUPABASE_URL: process.env.SUPABASE_URL,\n    SUPABASE_KEY: !!process.env.SUPABASE_KEY,\n    DEEPL_API_KEY: !!process.env.DEEPL_API_KEY,\n  });\n  res.setHeader(\"Access-Control-Allow-Origin\", \"*\");\n\n  // to prevent 405 error\n  if (req.method === \"OPTIONS\") {\n    res.setHeader(\"Access-Control-Allow-Methods\", \"POST, OPTIONS\");\n    res.setHeader(\"Access-Control-Allow-Headers\", \"Content-Type\");\n    return res.status(200).end();\n  }\n\n  // blocks everything except POST\n  if (req.method !== \"POST\") {\n    return res.status(405).json({ error: \"Method not allowed\" });\n  }\n\n  const { title, artist, originalLang, targetLang, originalLyrics } = req.body;\n\n  if (!title || !artist || !originalLang || !targetLang || !originalLyrics) {\n    return res.status(400).json({ error: \"Missing required inputs\" });\n  }\n\n  try {\n    // Check if translation exists\n    const { data: existing, error: selectError } = await supabase\n      .from(\"lyrics_data\")\n      .select(\n        \"title, artist, original_lyrics, translated_lyrics, original_lang, target_lang\"\n      )\n      .eq(\"title\", title)\n      .eq(\"artist\", artist)\n      .eq(\"original_lang\", originalLang)\n      .eq(\"target_lang\", targetLang)\n      .limit(1);\n\n    if (selectError) throw selectError;\n\n    if (existing && existing.length > 0) {\n      return res.status(200).json(existing[0]); // return previous translation\n    }\n\n    // fetching DEEPL API to get lyric translation\n    const deeplRes = await fetch(\"https://api-free.deepl.com/v2/translate\", {\n      method: \"POST\",\n      headers: { \"Content-Type\": \"application/x-www-form-urlencoded\" },\n      body: new URLSearchParams({\n        auth_key: DEEPL_API_KEY,\n        text: originalLyrics,\n        target_lang: targetLang,\n      }),\n    });\n\n    const deeplData = await deeplRes.json();\n    if (!deeplData.translations || !deeplData.translations[0].text) {\n      throw new Error(\"!!!DeepL translation failed!!!\");\n    }\n\n    const translatedLyrics = deeplData.translations[0].text;\n\n    // INSERT THE NEW TRANSLATION\n    const { data, error: insertError } = await supabase\n      .from(\"lyrics_data\")\n      .insert([\n        {\n          title,\n          artist,\n          original_lang: originalLang,\n          target_lang: targetLang,\n          original_lyrics: originalLyrics,\n          translated_lyrics: translatedLyrics,\n        },\n      ])\n      .select();\n\n    if (insertError) throw insertError;\n\n    return res.status(201).json(data[0]);\n  } catch (extra_err) {\n    console.error(extra_err);\n    return res.status(500).json({ error: extra_err.message });\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;;;;;;AAEA,kDAAkD;AAClD,MAAM,WAAW,IAAA,2OAAY,EAC3B,QAAQ,GAAG,CAAC,YAAY,EACxB,QAAQ,GAAG,CAAC,YAAY;AAG1B,gBAAgB;AAChB,MAAM,gBAAgB,QAAQ,GAAG,CAAC,aAAa;AAEhC,eAAe,QAAQ,GAAG,EAAE,GAAG;IAC5C,QAAQ,GAAG,CAAC;QACV,cAAc,QAAQ,GAAG,CAAC,YAAY;QACtC,cAAc,CAAC,CAAC,QAAQ,GAAG,CAAC,YAAY;QACxC,eAAe,CAAC,CAAC,QAAQ,GAAG,CAAC,aAAa;IAC5C;IACA,IAAI,SAAS,CAAC,+BAA+B;IAE7C,uBAAuB;IACvB,IAAI,IAAI,MAAM,KAAK,WAAW;QAC5B,IAAI,SAAS,CAAC,gCAAgC;QAC9C,IAAI,SAAS,CAAC,gCAAgC;QAC9C,OAAO,IAAI,MAAM,CAAC,KAAK,GAAG;IAC5B;IAEA,gCAAgC;IAChC,IAAI,IAAI,MAAM,KAAK,QAAQ;QACzB,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,OAAO;QAAqB;IAC5D;IAEA,MAAM,EAAE,KAAK,EAAE,MAAM,EAAE,YAAY,EAAE,UAAU,EAAE,cAAc,EAAE,GAAG,IAAI,IAAI;IAE5E,IAAI,CAAC,SAAS,CAAC,UAAU,CAAC,gBAAgB,CAAC,cAAc,CAAC,gBAAgB;QACxE,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,OAAO;QAA0B;IACjE;IAEA,IAAI;QACF,8BAA8B;QAC9B,MAAM,EAAE,MAAM,QAAQ,EAAE,OAAO,WAAW,EAAE,GAAG,MAAM,SAClD,IAAI,CAAC,eACL,MAAM,CACL,iFAED,EAAE,CAAC,SAAS,OACZ,EAAE,CAAC,UAAU,QACb,EAAE,CAAC,iBAAiB,cACpB,EAAE,CAAC,eAAe,YAClB,KAAK,CAAC;QAET,IAAI,aAAa,MAAM;QAEvB,IAAI,YAAY,SAAS,MAAM,GAAG,GAAG;YACnC,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC,QAAQ,CAAC,EAAE,GAAG,8BAA8B;QAC1E;QAEA,8CAA8C;QAC9C,MAAM,WAAW,MAAM,MAAM,2CAA2C;YACtE,QAAQ;YACR,SAAS;gBAAE,gBAAgB;YAAoC;YAC/D,MAAM,IAAI,gBAAgB;gBACxB,UAAU;gBACV,MAAM;gBACN,aAAa;YACf;QACF;QAEA,MAAM,YAAY,MAAM,SAAS,IAAI;QACrC,IAAI,CAAC,UAAU,YAAY,IAAI,CAAC,UAAU,YAAY,CAAC,EAAE,CAAC,IAAI,EAAE;YAC9D,MAAM,IAAI,MAAM;QAClB;QAEA,MAAM,mBAAmB,UAAU,YAAY,CAAC,EAAE,CAAC,IAAI;QAEvD,6BAA6B;QAC7B,MAAM,EAAE,IAAI,EAAE,OAAO,WAAW,EAAE,GAAG,MAAM,SACxC,IAAI,CAAC,eACL,MAAM,CAAC;YACN;gBACE;gBACA;gBACA,eAAe;gBACf,aAAa;gBACb,iBAAiB;gBACjB,mBAAmB;YACrB;SACD,EACA,MAAM;QAET,IAAI,aAAa,MAAM;QAEvB,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC,IAAI,CAAC,EAAE;IACrC,EAAE,OAAO,WAAW;QAClB,QAAQ,KAAK,CAAC;QACd,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,OAAO,UAAU,OAAO;QAAC;IACzD;AACF"}}]
}